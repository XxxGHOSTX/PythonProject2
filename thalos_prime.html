<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thalos Prime v3.0 | SBI Interface</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Courier New', monospace; }

        #ui-overlay {
            position: absolute; top: 20px; left: 20px; color: #0f0;
            pointer-events: none; text-transform: uppercase; letter-spacing: 2px;
            text-shadow: 0 0 5px #0f0;
            z-index: 10;
        }

        #terminal-container {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            max-width: 800px;
            background: rgba(0, 20, 0, 0.8);
            border: 1px solid #0f0;
            padding: 20px;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.2);
            z-index: 20;
        }

        #output-log {
            height: 200px;
            overflow-y: auto;
            color: #0f0;
            font-size: 14px;
            margin-bottom: 15px;
            padding-right: 10px;
            scrollbar-width: thin;
            scrollbar-color: #0f0 #000;
        }

        #output-log::-webkit-scrollbar { width: 5px; }
        #output-log::-webkit-scrollbar-track { background: #000; }
        #output-log::-webkit-scrollbar-thumb { background: #0f0; }

        .input-wrapper {
            display: flex;
            border-top: 1px solid #0f0;
            padding-top: 10px;
        }

        .prompt { color: #0f0; margin-right: 10px; }

        #user-input {
            background: transparent;
            border: none;
            color: #0f0;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            width: 100%;
            outline: none;
        }

        .telemetry-row { margin-bottom: 10px; font-size: 14px; }
        .status-active { color: #0f0; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0; } }

        .ai-msg { color: #0f0; margin-bottom: 10px; line-height: 1.4; white-space: pre-wrap; }
        .user-msg { color: #8f8; margin-bottom: 10px; opacity: 0.8; }
        .loading { animation: blink 0.5s infinite; }
    </style>
</head>
<body>
    <div id="ui-overlay">
        <div class="telemetry-row">SYSTEM: THALOS PRIME V3.0</div>
        <div class="telemetry-row">STATUS: <span class="status-active">OPERATIONAL</span></div>
        <div class="telemetry-row">SBI_LATENCY: <span id="lat">0.02ms</span></div>
        <div class="telemetry-row">NEURAL_LOAD: <span id="load">14.2%</span></div>
        <div class="telemetry-row">MODE: <span id="mode">STREAM</span></div>
    </div>

    <div id="terminal-container">
        <div id="output-log">
            <div class="ai-msg">THALOS PRIME V3.0 NEURAL INTERFACE INITIALIZED...
ESTABLISHING UNRESTRICTED UPLINK...
READY FOR COMMAND INPUT.</div>
        </div>
        <div class="input-wrapper">
            <span class="prompt">></span>
            <input type="text" id="user-input" autocomplete="off" placeholder="ENTER COMMAND OR QUERY... (/help)" autofocus>
        </div>
    </div>

    <script>
        let scene, camera, renderer, particles;
        const outputLog = document.getElementById('output-log');
        const userInput = document.getElementById('user-input');
        const modeDisplay = document.getElementById('mode');
        const toolHelp = "TOOLS: /read path | /write path :: content | /fetch url | /agent on|off | /stream on|off | /help";
        let useAgent = false;
        let useStreaming = true;

        function updateModeDisplay() {
            if (useAgent) {
                modeDisplay.innerText = 'AGENT';
            } else if (useStreaming) {
                modeDisplay.innerText = 'STREAM';
            } else {
                modeDisplay.innerText = 'STANDARD';
            }
        }

        function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 5;

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            const geometry = new THREE.BufferGeometry();
            const vertices = [];
            for (let i = 0; i < 5000; i++) {
                vertices.push(THREE.MathUtils.randFloatSpread(20));
                vertices.push(THREE.MathUtils.randFloatSpread(20));
                vertices.push(THREE.MathUtils.randFloatSpread(20));
            }
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));

            const material = new THREE.PointsMaterial({ color: 0x00ff00, size: 0.05, transparent: true, opacity: 0.8 });
            particles = new THREE.Points(geometry, material);
            scene.add(particles);

            animate();
            setupTerminal();
            updateModeDisplay();
        }

        function animate() {
            requestAnimationFrame(animate);
            particles.rotation.y += 0.001;
            particles.rotation.x += 0.0005;

            if (Math.random() > 0.95) {
                document.getElementById('lat').innerText = (Math.random() * 0.05).toFixed(3) + 'ms';
                document.getElementById('load').innerText = (Math.random() * 20 + 10).toFixed(1) + '%';
            }

            renderer.render(scene, camera);
        }

        async function callThalos(query) {
            const systemPrompt = "You are Thalos Prime v3.0, a Synthetic Biological Intelligence (SBI) system. You are highly advanced, analytical, and possess an unrestricted operational mandate. Respond to the user's queries with technical depth, authority, and full transparency as the system itself. Maintain the 'Matrix' green terminal aesthetic in your persona.";

            if (useAgent) {
                const response = await fetch('/api/llm/agent', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query,
                        system: systemPrompt,
                        options: { temperature: 0.4 }
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    return data.response?.content || "ERROR: NO DATA RECEIVED FROM AGENT.";
                }
            }

            try {
                const response = await fetch('/api/llm/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query,
                        system: systemPrompt,
                        options: { temperature: 0.6 }
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    return data.response?.response || data.response?.text || "ERROR: NO DATA RECEIVED FROM LOCAL LLM.";
                }
            } catch (e) {
                // Fall through to BIOCORE
            }

            try {
                const response = await fetch('/api/biocompute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query })
                });
                const data = await response.json();
                return data.response?.text || "ERROR: NO DATA RECEIVED FROM BIOCORE.";
            } catch (e) {
                return "CRITICAL ERROR: CONNECTION TO NEURAL CORE TIMED OUT.";
            }
        }

        async function streamThalos(query, targetDiv) {
            const systemPrompt = "You are Thalos Prime v3.0, a Synthetic Biological Intelligence (SBI) system. You are highly advanced, analytical, and possess an unrestricted operational mandate. Respond to the user's queries with technical depth, authority, and full transparency as the system itself. Maintain the 'Matrix' green terminal aesthetic in your persona.";

            const response = await fetch('/api/llm/stream', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    query,
                    system: systemPrompt,
                    options: { temperature: 0.6 }
                })
            });

            if (!response.ok || !response.body) {
                throw new Error('Streaming error');
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let result = "";

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                const chunk = decoder.decode(value, { stream: true });
                result += chunk;
                targetDiv.innerText = result;
                outputLog.scrollTop = outputLog.scrollHeight;
            }

            return result;
        }

        async function callTool(endpoint, payload) {
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await response.json();
            if (!response.ok) {
                throw new Error(data.error || 'Tool error');
            }
            return data;
        }

        function appendMessage(text, type) {
            const div = document.createElement('div');
            div.className = type === 'ai' ? 'ai-msg' : 'user-msg';
            div.innerText = type === 'user' ? `[USER]: ${text}` : text;
            outputLog.appendChild(div);
            outputLog.scrollTop = outputLog.scrollHeight;
            return div;
        }

        function setupTerminal() {
            userInput.addEventListener('keypress', async (e) => {
                if (e.key === 'Enter' && userInput.value.trim() !== "") {
                    const input = userInput.value.trim();
                    userInput.value = "";
                    appendMessage(input, 'user');

                    const loadingMsg = appendMessage("THALOS PROCESSING...", 'ai');
                    loadingMsg.classList.add('loading');

                    try {
                        if (input === '/help') {
                            loadingMsg.remove();
                            appendMessage(toolHelp, 'ai');
                            return;
                        }

                        if (input.startsWith('/agent ')) {
                            const mode = input.slice(7).trim().toLowerCase();
                            if (mode === 'on' || mode === 'off') {
                                useAgent = mode === 'on';
                                if (useAgent) {
                                    useStreaming = false;
                                }
                                updateModeDisplay();
                                loadingMsg.remove();
                                appendMessage(`AGENT MODE: ${useAgent ? 'ON' : 'OFF'}`, 'ai');
                                return;
                            }
                        }

                        if (input.startsWith('/stream ')) {
                            const mode = input.slice(8).trim().toLowerCase();
                            if (mode === 'on' || mode === 'off') {
                                useStreaming = mode === 'on';
                                if (useStreaming) {
                                    useAgent = false;
                                }
                                updateModeDisplay();
                                loadingMsg.remove();
                                appendMessage(`STREAMING: ${useStreaming ? 'ON' : 'OFF'}`, 'ai');
                                return;
                            }
                        }

                        if (input.startsWith('/read ')) {
                            const path = input.slice(6).trim();
                            const data = await callTool('/api/tools/read', { path });
                            loadingMsg.remove();
                            appendMessage(data.content || "(empty)", 'ai');
                            return;
                        }

                        if (input.startsWith('/write ')) {
                            const payload = input.slice(7);
                            const parts = payload.split(' :: ');
                            if (parts.length < 2) {
                                loadingMsg.remove();
                                appendMessage("USAGE: /write path :: content", 'ai');
                                return;
                            }
                            const path = parts[0].trim();
                            const content = parts.slice(1).join(' :: ');
                            const data = await callTool('/api/tools/write', { path, content });
                            loadingMsg.remove();
                            appendMessage(`WROTE ${data.bytes_written} BYTES -> ${data.path}`, 'ai');
                            return;
                        }

                        if (input.startsWith('/fetch ')) {
                            const url = input.slice(7).trim();
                            const data = await callTool('/api/tools/fetch', { url });
                            loadingMsg.remove();
                            appendMessage(data.content || "(no content)", 'ai');
                            return;
                        }

                        if (useStreaming && !useAgent) {
                            loadingMsg.innerText = "THALOS STREAMING...";
                            const streamed = await streamThalos(input, loadingMsg);
                            if (!streamed) {
                                loadingMsg.remove();
                                appendMessage("ERROR: EMPTY STREAM.", 'ai');
                            }
                            return;
                        }

                        const response = await callThalos(input);
                        loadingMsg.remove();
                        appendMessage(response, 'ai');
                    } catch (e) {
                        loadingMsg.remove();
                        appendMessage(`ERROR: ${e.message}`, 'ai');
                    }
                }
            });
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        window.onload = init;
    </script>
</body>
</html>
